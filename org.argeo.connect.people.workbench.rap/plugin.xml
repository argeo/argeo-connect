<?xml version="1.0" encoding="UTF-8"?>
<?eclipse version="3.4"?>
<plugin>
	<!-- Perspective --> 
	<extension
    	point="org.eclipse.ui.perspectives">
    	<!-- People default standalone perspective --> 
		<perspective
            id="org.argeo.connect.people.workbench.rap.peoplePerspective"
			icon="icons/people.gif"
			class="org.argeo.connect.people.workbench.rap.PeoplePerspective"
            name="People">
		</perspective>
	</extension>

    <!-- VIEWS -->
    <extension
		point="org.eclipse.ui.views">
		<!-- People specific views -->
		<view
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/people.gif"
			id="org.argeo.connect.people.workbench.rap.quickSearchView"
			name="Contacts"
			restorable="true">
		</view>
		<view
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/activities/todo.gif"
			id="org.argeo.connect.people.workbench.rap.myTodoListView"
			name="Tasks"
			restorable="true">
		</view>
		<!-- Legacy -->
		<view
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/people.gif"
			id="org.argeo.connect.people.workbench.rap.peopleDefaultView"
			name="Search"
			restorable="true">
		</view>
	</extension>
	
	<!-- EDITORS -->
    <extension
		point="org.eclipse.ui.editors">
		<!-- Search -->
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/search.png"
			id="org.argeo.connect.people.workbench.rap.defaultSearchEntityEditor"
			name="Search">
		</editor>
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/search.png"
			id="org.argeo.connect.people.workbench.rap.listValuesEditor"
			name="Search">
		</editor>
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/search.png"
			id="org.argeo.connect.people.workbench.rap.searchByTagEditor"
			name="Search by Tag">
		</editor>
		
		<!-- Entities -->
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/person.gif"
			id="org.argeo.connect.people.workbench.rap.personEditor"
			name="Person editor">
		</editor>
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/company.png"
			id="org.argeo.connect.people.workbench.rap.orgEditor"
			name="Organisation editor">
		</editor>
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/group.gif"
			id="org.argeo.connect.people.workbench.rap.groupEditor"
			name="Group">
		</editor>
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/entities/tag.png"
			id="org.argeo.connect.people.workbench.rap.tagEditor"
			name="Tag">
		</editor>
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/mailingList.gif"
			id="org.argeo.connect.people.workbench.rap.mailingListEditor"
			name="Mailing List">
		</editor>
		
		<!-- Activities -->
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/activities/todo.gif"
			id="org.argeo.connect.people.workbench.rap.activityEditor"
			name="Activity editor">
		</editor>
		<editor
			class="org.argeo.eclipse.spring.SpringExtensionFactory"
			icon="icons/activities/todo.gif"
			id="org.argeo.connect.people.workbench.rap.taskEditor"
			name="Task editor">
		</editor>
	</extension>
	
	<!-- COMMANDS -->
	<extension
		point="org.eclipse.ui.commands">
		<!-- Open correct editor given the node type --> 
    	<command
			id="org.argeo.connect.people.workbench.rap.openEntityEditor"
			defaultHandler="org.argeo.eclipse.spring.SpringCommandHandler"
			name="Open Editor">
			<commandParameter
         		id="param.jcrId"
         		name="The jcr identifier">
         	</commandParameter>
			<commandParameter
				id="param.cTabId"
				name="The id of the tab to open if such a tab exists">
			</commandParameter>
			<commandParameter
				id="param.openForEdit"
				name="A flag to try to open the corresponding entity for edition">
			</commandParameter>
			<!-- Still used to open editor with the linked list (employees...) -->
			<commandParameter
				id="param.entityUid"
				name="The Model Specific Entity Uid">
			</commandParameter>
		</command>    
		
		<!-- Search entities by type -->
		<command
			id="org.argeo.connect.people.workbench.rap.openSearchEntityEditor"
			defaultHandler="org.argeo.connect.people.workbench.rap.commands.OpenSearchEntityEditor"
			name="Open Search Entity Editor">
			<commandParameter
				id="param.nodeType"
				name="Node Type">
			</commandParameter>
			<commandParameter
				id="param.editorName"
				name="Editor Name">
			</commandParameter>
			<commandParameter
				id="param.basePath"
				name="Parent base path">
			</commandParameter>
		</command>

		<!-- Exports -->
		<command
			defaultHandler="org.argeo.eclipse.spring.SpringExtensionFactory"
      		id="org.argeo.connect.ui.workbench.getJxlExport"
            name="Generate a spreadsheet export">
            <commandParameter
         		id="param.exportId"
         		name="An export ID">
  	 		</commandParameter>
    	</command>

		<!-- Person and organisation management --> 
		<command
			id="org.argeo.connect.people.workbench.rap.editJob"
            defaultHandler="org.argeo.eclipse.spring.SpringExtensionFactory"
      		name="Create or edit a job">
            <commandParameter
         		id="param.relevantNodeJcrId"
         		name="Jcr ID of the node to edit">
  	 		</commandParameter>
            <commandParameter
         		id="param.isBackward"
         		name="When editing an existing job, true if editing an org">
  	 		</commandParameter>
    	</command>
   	
    	<!-- Activities and tasks management --> 
    	<command
      		id="org.argeo.connect.people.workbench.rap.createSimpleTask"
            defaultHandler="org.argeo.eclipse.spring.SpringExtensionFactory"
      		name="Create simple task">
        </command>
    	
    	<!-- Add global life cycle on Editors  -->
		<!-- Note: corresponding handler could also be defined below in the startup part -->
		<command
      		defaultHandler="org.argeo.connect.people.workbench.rap.commands.ChangeEditingState"
			id="org.argeo.connect.people.workbench.rap.changeEditingState"
            name="changeEditingState">
			<commandParameter
         		id="param.newEditingState"
         		name="The new global editing state">
  	 		</commandParameter>
  	 		<commandParameter
         		id="param.priorAction"
         		name="checkout, save or cancel">
  	 		</commandParameter>
    	</command>
    	
    	<!-- Entity CRUD --> 
		<command
      		id="org.argeo.connect.people.workbench.rap.createEntity"
			defaultHandler="org.argeo.eclipse.spring.SpringExtensionFactory"
            name="createEntity">
            <commandParameter
         		id="param.targetNodeType"
         		name="Target Node Type">
  	 		</commandParameter>
    	</command>
    	
		<command
			id="org.argeo.connect.people.workbench.rap.deleteEntity"
            defaultHandler="org.argeo.eclipse.spring.SpringExtensionFactory"
      		name="deleteEntity">
            <commandParameter
         		id="param.toRemoveJcrId"
         		name="Jcr ID of the node to remove">
  	 		</commandParameter>
            <commandParameter
         		id="param.removeParent"
         		name="Indicates whether parent node should also be deleted">
  	 		</commandParameter>
    	</command>
    
		<!-- Entity References CRUD --> 
		<command
			id="org.argeo.connect.people.workbench.rap.removeEntityReference"
        	defaultHandler="org.argeo.eclipse.spring.SpringExtensionFactory"
      	    name="removeEntityReference">
            <commandParameter
         		id="param.toRemoveJcrId"
         		name="Jcr ID of the node to remove">
  	 		</commandParameter>
    	</command>
    	<!-- Utility command to simply open an URL --> 
    	<command
			defaultHandler="org.argeo.connect.people.workbench.rap.commands.OpenUrl"
			id="org.argeo.connect.people.workbench.rap.openUrl"
			name="Open an URL in the end user browser">
			<commandParameter
     			id="param.urlValue"
     			name="The url">
 			</commandParameter>
			<commandParameter
     			id="param.urlType"
     			name="The type of the url">
 			</commandParameter>
  		</command>

  		<!-- Miscelleanous -->
  		<command
			id="org.argeo.connect.people.workbench.rap.forceRefresh"
			defaultHandler="org.argeo.connect.people.workbench.rap.commands.ForceRefresh"
			name="Force refresh of the current active part if such an action is possible">
			<commandParameter
					id="param.viewId"
					name="optionnaly, the id of the view to refresh">
 			</commandParameter>
  		</command>
	</extension>		
	
	<!-- Menus -->
	<extension
		point="org.eclipse.ui.menus">
		<!-- Generic commands provided by the people app --> 
		<menuContribution
			locationURI="toolbar:org.argeo.cms.ui.workbench.rap.userToolbar?before=org.eclipse.ui.file.save"> 
			<!-- Force resfresh if possible --> 
			<command
				commandId="org.argeo.connect.people.workbench.rap.forceRefresh"
				icon="icons/refresh.png"
				label="Force refresh of the current active part"
				style="push"
				tooltip="Force refresh of the current active part">
				<visibleWhen>
					<with variable="activePart">
						<instanceof value="org.argeo.connect.ui.workbench.Refreshable" />
					</with>
				</visibleWhen>
			</command>
		</menuContribution>
		
		<menuContribution
			locationURI="toolbar:org.argeo.cms.ui.workbench.rap.userToolbar?after=org.eclipse.ui.file.saveAll"> 
			<!-- Check in and out management --> 
 			<command
				commandId="org.argeo.connect.people.workbench.rap.changeEditingState"
				icon="icons/checkout.gif"
				label="Check Out"
				style="push"
				tooltip="Check Out item for edit">
				<visibleWhen>
					<and>
						<with variable="activePart">
							<instanceof value="org.argeo.cms.ui.CmsEditable" />
						</with>
						<with variable="org.argeo.connect.people.workbench.rap.editingState">
							<equals value="notEditing" />
						</with>
			    	</and>
				</visibleWhen>
				<parameter name="param.newEditingState" value="editing" />
  	 			<parameter name="param.priorAction" value="checkout" />
			</command>
			
			<!-- Add global life cycle on Editors  -->
			<command
				commandId="org.argeo.connect.people.workbench.rap.changeEditingState"
				icon="icons/cancelEdit.gif"
				label="Cancel edit"
				style="push"
				tooltip="Abandon changes and check back in">
				<visibleWhen>
					<and>
						<with variable="activePart">
							<instanceof value="org.argeo.cms.ui.CmsEditable" />
						</with>
						<with variable="org.argeo.connect.people.workbench.rap.editingState">
							<equals value="editing" />
						</with>
			    	</and>
				</visibleWhen>
				<parameter name="param.newEditingState" value="notEditing" />
  	 			<parameter name="param.priorAction" value="cancel" />
    		</command>
		</menuContribution>
				
		<!-- Corresponding submenus --> 
		<menuContribution locationURI="menu:org.argeo.connect.ui.workbench.addEntityToolbar">
			<command
				commandId="org.argeo.connect.people.workbench.rap.createEntity"
				icon="icons/person.gif"
				label="Person">
				<parameter
         		name="param.targetNodeType"
         		value="people:person" />
			</command>	
			<command
				commandId="org.argeo.connect.people.workbench.rap.createEntity"
				icon="icons/company.png"
				label="Organisation">
				<parameter
         		name="param.targetNodeType"
         		value="people:org" />
			</command>	
			<command
				commandId="org.argeo.connect.people.workbench.rap.createSimpleTask"
				icon="icons/activities/todo.gif"
				label="Task">
			</command>	
			<!--<command
				commandId="org.argeo.connect.people.workbench.rap.createEntity"
				icon="icons/mailingList.gif"
				label="Mailing List">
				<parameter
         		name="param.targetNodeType"
         		value="people:mailingList" />
			</command>-->
		</menuContribution>
		
		<menuContribution locationURI="menu:org.argeo.connect.ui.workbench.openSearchToolbar">
			<command
				commandId="org.argeo.connect.people.workbench.rap.openSearchEntityEditor"
				icon="icons/entities/person.gif"
				label="Persons">
				<parameter name="param.nodeType" value="people:person" />
				<parameter name="param.editorName" value="Persons" />
			</command>	
			<command
				commandId="org.argeo.connect.people.workbench.rap.openSearchEntityEditor"
				icon="icons/entities/company.png"
				label="Organisations">
				<parameter name="param.nodeType" value="people:org" />
				<parameter name="param.editorName" value="Organisations" />
			</command>	
			<command
				commandId="org.argeo.connect.people.workbench.rap.openSearchEntityEditor"
				icon="icons/activities/todo.gif"
				label="Tasks">
				<parameter name="param.nodeType" value="people:task" />
				<parameter name="param.editorName" value="Tasks" />
			</command>	
		</menuContribution>		
		
		<!-- EXPORTS MENU -->
		<menuContribution locationURI="toolbar:org.eclipse.ui.main.toolbar?after=org.argeo.cms.ui.workbench.rap.userToolbar">
			<toolbar id="org.argeo.connect.people.workbench.rap.exportToolbar">
				<!-- Spreadsheet extracts --> 
				<command
					commandId="org.argeo.connect.ui.workbench.getJxlExport"
					icon="icons/spreadsheet.gif"
					label="Generate extract"
					style="push"
					tooltip="Generate a spreadsheet export of the current active filtered list">
					<visibleWhen>
						<and>
							<with variable="activePart">
								<instanceof value="org.argeo.connect.ui.IJcrTableViewer" />
							</with>
						</and>
					</visibleWhen>
				</command>
			</toolbar>
		</menuContribution>
	
		
		<!-- MyTodoListView tool bar menu --> 
		<menuContribution
            locationURI="toolbar:org.argeo.connect.people.workbench.rap.myTodoListView">
            <command
				commandId="org.argeo.connect.people.workbench.rap.createSimpleTask"
				icon="icons/newGroup.gif"
				label="Task">
			</command>	
            <command
				commandId="org.argeo.connect.people.workbench.rap.forceRefresh"
                icon="icons/refresh.png"
				label="Refresh"
				tooltip="Force task list refresh">
				<parameter
					name="param.viewId"
					value="org.argeo.connect.people.workbench.rap.myTodoListView" />
            </command>
        </menuContribution>
	</extension>
	
	<!-- Workbench listeners --> 
	<extension point="org.eclipse.ui.startup">
   		<startup class="org.argeo.eclipse.spring.SpringExtensionFactory"
   			        id="org.argeo.connect.people.workbench.rap.partStateChanged">
   		</startup>
	</extension>

	<!-- Services -->
	<extension
      	point="org.eclipse.ui.services">
	   	<sourceProvider
	        provider="org.argeo.connect.people.workbench.rap.util.EditionSourceProvider">
	     	<variable
	            name="org.argeo.connect.people.workbench.rap.editingState"
	            priorityLevel="workbench">
	      	</variable>
	   	</sourceProvider>
	</extension>

	<extension
		point="org.eclipse.ui.activities">
		<!-- People specific activities --> 
		<activity
              description="Generic people app"
              id="org.argeo.connect.people.workbench.rap.peopleAppActivity"
              name="People App Activity">
		  <enabledWhen>
		    <with variable="roles">
		      <iterate ifEmpty="false" operator="or">
		        <equals value="cn=org.argeo.connect.people.member,ou=roles,ou=node" />
		      </iterate>
		    </with>
		 </enabledWhen>
        </activity>
        
        <activityPatternBinding
              activityId="org.argeo.connect.people.workbench.rap.peopleAppActivity"
              isEqualityPattern="true"
              pattern="org.argeo.connect.people.workbench.rap/org.argeo.connect.people.workbench.rap.peoplePerspective">
        </activityPatternBinding>

		<!-- Business admin activities --> 
		<activity
              description="Business admin activities"
              id="org.argeo.connect.people.workbench.rap.businessAdminActivity"
              name="People Business Admin">
		  <enabledWhen>
		    <with variable="roles">
		      <iterate ifEmpty="false" operator="or">
		        <equals value="cn=org.argeo.connect.people.admin,ou=roles,ou=node" />
		      </iterate>
		    </with>
		  </enabledWhen>
        </activity>

        
		<!-- Technical admin activities --> 
		<!-- TODO clean the activity strategy -->
		<activity
              description="Only for admins"
              id="org.argeo.connect.people.workbench.rap.adminActivity"
              name="People Admin">
		  <enabledWhen>
		    <with variable="roles">
		      <iterate ifEmpty="false" operator="or">
		        <equals value="cn=org.argeo.connect.people.admin,ou=roles,ou=node" />
		      </iterate>
		    </with>
		  </enabledWhen>
        </activity>
     </extension>
</plugin>
